<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Xariflaw DKP</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <!-- Layout styles -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- End layout styles -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <link rel="shortcut icon" href="assets/images/favicon.png" />
  <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script> -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/css/bootstrap/tabulator_bootstrap4.min.css"
    integrity="sha512-pXZ8FsuOBAyDmJ3OWob4V2UgZWQ8zs8f99MrNv0sBG8VLzuucajpzJ3BIiVNzTpfIYgzWGUq0QPJ3Y/9Gr4h7Q=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

  <script>var whTooltips = { colorLinks: true, iconizeLinks: true, renameLinks: true };</script>
</head>

<body>
  <div class="container-scroller">
    <!-- partial:partials/_sidebar.html -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
        <a class="sidebar-brand brand-logo" href="index.html">
          <h4>Xariflaw DKP</h4>
        </a>
        <a class="sidebar-brand brand-logo-mini" href="index.html">
          <h4>DKP</h4>
        </a>
      </div>
      <ul class="nav">
        <li class="nav-item nav-category">
          <span class="nav-link">Navigation</span>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="#" onclick="openTab('DKP');return false;">
            <span class="menu-icon">
              <i class="mdi mdi-speedometer"></i>
            </span>
            <span class="menu-title">DKP List</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="#" onclick="openTab('DKPHistory');return false;">
            <span class="menu-icon">
              <i class="mdi mdi-playlist-play"></i>
            </span>
            <span class="menu-title">DKP History</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="#" onclick="openTab('LootHistory');return false;">
            <span class="menu-icon">
              <i class="mdi mdi-table-large"></i>
            </span>
            <span class="menu-title">Loot History</span>
          </a>
        </li>
      </ul>
    </nav>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
      <!-- partial:partials/_navbar.html -->
      <nav class="navbar p-0 fixed-top d-flex flex-row">
        <div class="navbar-brand-wrapper d-flex d-lg-none align-items-center justify-content-center">
        </div>
        <div class="navbar-menu-wrapper flex-grow d-flex align-items-stretch">
          <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
            <span class="mdi mdi-menu"></span>
          </button>
          <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
            data-toggle="offcanvas">
            <span class="mdi mdi-format-line-spacing"></span>
          </button>
        </div>
      </nav>
      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row ">
            <div class="col-12 grid-margin">
              <div class="card">
                <div class="card-body">
                  <div id="DKP" class="tab">
                    <h4 class="card-title">DKP List</h4>
                    <div class="table-responsive">
                      <div class="table-dark" id="dkp_table"></div>
                    </div>
                  </div>
                  <div id="DKPHistory" class="tab">
                    <h4 class="card-title">DKP History</h4>
                    <div class="table-responsive">
                      <div class="table-dark" id="DKPHistory_table"></div>
                    </div>
                  </div>
                  <div id="LootHistory" class="tab">
                    <h4 class="card-title">Loot History</h4>
                    <div class="table-responsive">
                      <div class="table-dark" id="LootHistory_table"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:partials/_footer.html -->
        <footer class="footer">
          <div class="d-sm-flex justify-content-center justify-content-sm-between">
            <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">Copyright Â© bootstrapdash.com
              2020</span>
            <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"> Free <a
                href="https://www.bootstrapdash.com/bootstrap-admin-template/" target="_blank">Bootstrap admin
                templates</a> from Bootstrapdash.com</span>
          </div>
        </footer>
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>
  <!-- container-scroller -->
  <!-- plugins:js -->
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <script src="assets/vendors/chart.js/Chart.min.js"></script>
  <script src="assets/vendors/progressbar.js/progressbar.min.js"></script>
  <script src="assets/vendors/jvectormap/jquery-jvectormap.min.js"></script>
  <script src="assets/vendors/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
  <script src="assets/vendors/owl-carousel-2/owl.carousel.min.js"></script>
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="assets/js/off-canvas.js"></script>
  <script src="assets/js/hoverable-collapse.js"></script>
  <script src="assets/js/misc.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/todolist.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <script src="assets/js/dashboard.js"></script>
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/js/modules/filter.min.js"
    integrity="sha512-J/2V19TQdHn/8oyzZgYlHkh+y0qj1Tugk053az58joreDpSrNPXb89MxZLx7Fy/9/3BgGZfpfLfDPK8oGg/QXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/js/modules/mutator.min.js"
    integrity="sha512-b3j7bJ9q8EpyWcaesZmB/1vMfQAhvPT5DrF26r15/3gc6zz6+XH2tntqexeO5ltaDbTbX1PGwRmXrc/wy1Dv5w=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://wow.zamimg.com/widgets/power.js"></script>
</body>
<script>
  function openTab(tabName) {
    var i;
    var x = document.getElementsByClassName("tab");
    for (i = 0; i < x.length; i++) {
      x[i].style.display = "none";
    }
    document.getElementById(tabName).style.display = "block";
    if (tabName == 'LootHistory' || tabName == 'Crafter') {
      setTimeout(function () {
        window.$WowheadPower.init();
      }, 100);
    }
  }
  //var csv is the CSV file with headers
  openTab('DKP');


  function csvJSON(csv) {

    var lines = csv.split("\n");

    var result = [];

    // NOTE: If your columns contain commas in their values, you'll need
    // to deal with those before doing the next step 
    // (you might convert them to &&& or something, then covert them back later)
    // jsfiddle showing the issue https://jsfiddle.net/
    var headers = lines[0].split(",");

    for (var i = 1; i < lines.length; i++) {

      var obj = {};
      var currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);

      for (var j = 0; j < headers.length; j++) {
        obj[headers[j]] = currentline[j];
      }

      result.push(obj);

    }

    //return result; //JavaScript object
    return result; //JSON
  }

  var dkp_data = [];

  jQuery.get('https://knoxz.github.io/dkp.csv', function (data) {
    dkp_data = csvJSON(data);
    console.log("DKP");
    console.log(dkp_data);
    dkp_table.setData(dkp_data);
  });
  jQuery.get('https://knoxz.github.io/dkp_history.csv', function (data) {
    let dkp_history_data = csvJSON(data);
    console.log("DKP_History");
    console.log(dkp_history_data);
    DKPHistory_table.setData(dkp_history_data);
  });
  jQuery.get('https://knoxz.github.io/loot_history.csv', function (data) {
    let loot_history_data = csvJSON(data);
    console.log("Loot_History");
    console.log(loot_history_data);
    LootHistory_table.setData(loot_history_data);
  });

  function class_formatter(cell, formatterParams, onRendered) {
    var date = new Date(cell.getValue() * 1000);
    // 
    return `<img src="https://wow.zamimg.com/images/wow/icons/large/classicon_${cell.getValue().toLowerCase()}.jpg" height="24" width="24" />`
  }

  function date_formatter(cell, formatterParams, onRendered) {
    var date = new Date(cell.getValue() * 1000);
    // console.log(date);
    return date.toLocaleString('de-DE'); //return the contents of the cell;
  }

  function item_links(cell, formatterParams, onRendered) {
    let a_node = document.createElement("a");
    a_node.href = `https://tbc.wowhead.com/item=${cell.getValue().id}`;
    a_node.setAttribute("data-wowhead", `item=${cell.getValue().id}`);
    item_id_node = document.createTextNode(``);
    a_node.appendChild(item_id_node);

    // <div class="divPlayer" style="width: 40%;"><a href="https://tbc.wowhead.com/item=30450" data-wowhead="item=30450"></a>
    return a_node; //return the contents of the cell;
  }

  //define custom mutator
  var combine_name_id = function (value, data, type, params, component) {

    return { name: data.itemName, id: value }; //return the new value for the cell data.
  }

  var class_colors = {
    HUNTER: "#AAD372",
    DRUID: "#FF7C0A",
    MAGE: "#3FC7EB",
    PALADIN: "#F48CBA",
    PRIEST: "#FFFFFF",
    ROGUE: "#FFF468",
    SHAMAN: "#0086FF",
    WARLOCK: "#8788EE",
    WARRIOR: "#C69B6D"
  };

  var dkp_table = new Tabulator("#dkp_table", {
    // layout: "fitDataTable", //fit columns to width of table (optional)
    rowFormatter: function (row) {
      row.getElement().style.color = class_colors[row.getData().class];

    },
    columns: [ //Define Table Columns
      // player,class,DKP,previousDKP,lifetimeGained,lifetimeSpent
      { title: "Player", field: "player" },
      { title: "Class", field: "class", formatter: class_formatter },
      { title: "DKP", field: "DKP", width: 110 },
      { title: "Spent", field: "lifetimeSpent", width: 110 },
      { title: "BenchTime", field: "benchtime", width: 150 },
    ]
  });

  var DKPHistory_table = new Tabulator("#DKPHistory_table", {
    layout: "fitColumns", //fit columns to width of table (optional)
    columns: [ //Define Table Columns
      // player,class,DKP,previousDKP,lifetimeGained,lifetimeSpent
      { title: "Player", field: "player", formatter: "textarea" },
      { title: "DKP", field: "DKP" },
      { title: "date", field: "date", formatter: date_formatter },
      { title: "reason", field: "reason" }
    ]
  });

  var LootHistory_table = new Tabulator("#LootHistory_table", {
    layout: "fitColumns", //fit columns to width of table (optional)
    rowFormatter: function (row) {
      dkp_data.forEach(element => {
        if (element.player == row.getData().player) {
          row.getElement().style.color = class_colors[element.class];
        }
      })
      row.getElement().style.color = class_colors[row.getData().class];

    },
    columns: [ //Define Table Columns
      // player,class,DKP,previousDKP,lifetimeGained,lifetimeSpent
      { title: "Player", field: "player", width: 150 },
      // { title: "itemName", field: "itemName" },
      {
        title: "Item", field: "itemNumber", mutator: combine_name_id, formatter: item_links, sorter: function (a, b, aRow, bRow, column, dir, sorterParams) {
          //a, b - the two values being compared
          //aRow, bRow - the row components for the values being compared (useful if you need to access additional fields in the row data for the sort)
          //column - the column component for the column being sorted
          //dir - the direction of the sort ("asc" or "desc")
          //sorterParams - sorterParams object from column definition array

          return a.id - b.id; //you must return the difference between the two values
        },
      },
      { title: "Zone", field: "zone" },
      { title: "Boss", field: "boss" },
      { title: "Date", field: "date", formatter: date_formatter, width: 175 },
      { title: "Cost", field: "cost", width: 90 },
    ]
  });

  var tableData = [
    { id: 1, player: "Designflawz", profession: "Leatherworking", item: { id: "30303" } },
    { id: 2, player: "Designflawz", profession: "Leatherworking", item: { id: "30301" } },
    { id: 2, player: "Keyan", profession: "Tailoring", item: { id: "30280" } },
    { id: 2, player: "Gnomorah", profession: "Blacksmithing", item: { id: "30322" } },
  ];

  console.log(tableData);
  var crafter_table = new Tabulator("#Crafter_table", {
    data: tableData,
    layout: "fitColumns", //fit columns to width of table (optional)
    groupBy: ["profession"],
    groupValues: [["Leatherworking", "Blacksmithing", "Tailoring"]],
    // groupHeader: [
    //   function (value, count, data) { //generate header contents for gender groups
    //     return value + "<span style='color:#d00; margin-left:10px;'>(" + count + " item)</span>";
    //   },
    //   function (value, count, data) { //generate header contents for color groups
    //     class_color = "#0dd"
    //     dkp_data.forEach(element => {
    //       if (element.player == value) {
    //         class_color = class_colors[element.class];
    //       }
    //     });
    //     return "<span style='color:" + class_color + "; margin-left:10px;'>" + value + "</span>";
    //   },
    // ],
    rowFormatter: function (row) {
      dkp_data.forEach(element => {
        if (element.player == row.getData().player) {
          row.getElement().style.color = class_colors[element.class];
        }
      })
      row.getElement().style.color = class_colors[row.getData().class];

    },
    columns: [ //Define Table Columns
      // player,class,DKP,previousDKP,lifetimeGained,lifetimeSpent
      { title: "Player", field: "player", width: 150 },
      {
        title: "Item", field: "item", formatter: item_links, sorter: function (a, b, aRow, bRow, column, dir, sorterParams) {
          return a.id - b.id; //you must return the difference between the two values
        },
      },
      // { title: "Profession", field: "profession" },
    ]
  });

  $.get("https://docs.google.com/spreadsheets/d/e/2PACX-1vRHfrzDCNtlpSqy5XYfeAlT2KvQ8acO3hD5O2l3j1CFmLjbcbfcd1DZcPWUrnHCzbpdjiVMS9S48MZj/pub?gid=1567231630&single=true&output=csv", function (data) {
    data = "name,class,benchtime,null,null,null,null\n" + data;
    bench_array = csvJSON(data);
    console.log("Bench Function");
    console.log(bench_array);
    dkp_data = dkp_table.getData();
    bench_array.forEach(player => {
      dkp_data.forEach(dkp_data_player => {
        if (player["name"] == dkp_data_player["player"]) {
          dkp_data_player["benchtime"] = player["benchtime"];
        }
      });
    });
    console.log(dkp_data);
    dkp_table.setData(dkp_data);
  });

</script>

</html>